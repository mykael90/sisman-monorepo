// =================================================================
// ==              MODELS PARA ATIVOS DE INFRAESTRUTURA           ==
// =================================================================

model FacilityComplex {
    id        String               @id
    name      String
    address   String?
    latitude  Decimal?             @db.Decimal(8, 6)
    longitude Decimal?             @db.Decimal(9, 6)
    type      FacilityComplexType?

    buildings InfrastructureBuilding[]

    @@map("infrastructure_facilities_complexes")
}

enum FacilityComplexType {
    BUILDING   @map("EDIFICIO")
    FARM       @map("FAZENDA")
    HOSPITAL   @map("HOSPITAL")
    LABORATORY @map("LABORATORIO")
    LAND       @map("TERRENO")
    MUSEUM     @map("MUSEU")
    OTHER      @map("OUTRO")
    RESIDENCE  @map("RESIDENCIA")
    OFFICE     @map("ESCRITORIO")
    STATION    @map("ESTACAO")
    UNIVERSITY @map("UNIVERSIDADE")
    WAREHOUSE  @map("GALPAO")
}

model InfrastructureBuilding {
    id                           String                           @id
    name                         String
    alias                        String?
    description                  String?
    address                      String?
    latitude                     Decimal?                         @db.Decimal(8, 6)
    longitude                    Decimal?                         @db.Decimal(9, 6)
    createdAt                    DateTime                         @default(now())
    updatedAt                    DateTime                         @updatedAt
    restrictedAccess             Boolean                          @default(false) //Somente pessoas autorizadas acessam essa infraestrutura
    managers                     User[]                           @relation("Managers")
    spaces                       InfrastructureSpace[]
    systems                      InfrastructureSystem[]
    maintenanceRequests          MaintenanceRequest[]
    infraOccurrences             InfrastructureOccurrence[]
    facilityComplex              FacilityComplex?                 @relation(fields: [facilityComplexId], references: [id])
    facilityComplexId            String?
    infrastructureBuildingTypeId Int?
    primaryActivity              InfrastructureBuildingActivity?  @relation("PrimaryActivity", fields: [infrastructureBuildingTypeId], references: [id])
    secondariesActivities        InfrastructureBuildingActivity[] @relation("SecondaryActivity")

    maintenanceInstance   MaintenanceInstance? @relation(fields: [maintenanceInstanceId], references: [id])
    maintenanceInstanceId Int?

    unidadesSipacVinculadas SipacUnidade[] @relation("UnidadesVinculadasInfraestrutura")

    @@index([facilityComplexId])
    @@index([infrastructureBuildingTypeId])
    @@map("infrastructure_buildings")
}

model InfrastructureBuildingActivity {
    id          Int     @id @default(autoincrement())
    name        String  @unique
    description String?

    buldingsSecondary          InfrastructureBuilding[]     @relation("SecondaryActivity")
    buldingsPrimary            InfrastructureBuilding[]     @relation("PrimaryActivity")
    InfrastructureBuildingType InfrastructureBuildingType[]

    @@map("infrastructure_building_activities")
}

model InfrastructureBuildingType {
    id                               Int                            @id @default(autoincrement())
    name                             String                         @unique
    description                      String?
    infrastructureBuildingActivity   InfrastructureBuildingActivity @relation(fields: [infrastructureBuildingActivityId], references: [id])
    infrastructureBuildingActivityId Int

    @@map("infrastructure_building_types")
}

// Modelo SpaceType, agora como um modelo para flexibilidade.
model InfrastructureSpaceType {
    id          Int                   @id @default(autoincrement())
    name        String                @unique
    description String?
    icon        String?
    isActive    Boolean               @default(true)
    createdAt   DateTime              @default(now()) @db.Timestamp(0)
    updatedAt   DateTime              @updatedAt @db.Timestamp(0)
    spaces      InfrastructureSpace[]

    @@map("infrastructure_space_types")
}

model InfrastructureSpace {
    id                      Int                        @id @default(autoincrement())
    name                    String
    description             String?                    @db.Text
    keyCode                 String?
    spaceTypeId             Int
    spaceType               InfrastructureSpaceType    @relation(fields: [spaceTypeId], references: [id], onDelete: Restrict)
    regionType              RegionType                 @default(INTERNAL)
    buildingId              String
    building                InfrastructureBuilding     @relation(fields: [buildingId], references: [id], onDelete: Cascade)
    parentId                Int?
    parent                  InfrastructureSpace?       @relation("NestedSpaces", fields: [parentId], references: [id], onDelete: NoAction)
    children                InfrastructureSpace[]      @relation("NestedSpaces")
    maintenanceRequests     MaintenanceRequest[]
    infraOccurrences        InfrastructureOccurrence[]
    createdAt               DateTime                   @default(now()) @db.Timestamp(0)
    updatedAt               DateTime                   @updatedAt @db.Timestamp(0)
    InfrastructureSpaceUser InfrastructureSpaceUser[]

    @@index([buildingId])
    @@index([parentId])
    @@index([spaceTypeId])
    @@map("infrastructure_spaces")
}

model InfrastructureSpaceUser {
    id                    Int                 @id @default(autoincrement())
    spaceId               Int
    space                 InfrastructureSpace @relation(fields: [infrastructureSpaceId], references: [id])
    infrastructureSpaceId Int
    user                  User                @relation(fields: [userId], references: [id])
    userId                Int
    createdAt             DateTime            @default(now()) @db.Timestamp(0)
    updatedAt             DateTime            @updatedAt @db.Timestamp(0)

    @@index([spaceId, userId])
    @@map("infrastructure_space_users")
}

enum RegionType {
    INTERNAL  @map("INTERNO") // Espaço interno da edificação
    EXTERNAL  @map("EXTERNO") // Espaço externo da edificação, exemplo jardim, estacionamento, etc.
    INTERFACE @map("INTERFACE") // Espaço de interface da edificação, exemplo fachada
}

model InfrastructureSystem {
    id                  Int                      @id @default(autoincrement())
    name                String
    type                String
    description         String?                  @db.Text
    buildings           InfrastructureBuilding[]
    maintenanceRequests MaintenanceRequest[]
    createdAt           DateTime                 @default(now()) @db.Timestamp(0)
    updatedAt           DateTime                 @updatedAt @db.Timestamp(0)

    @@unique([name, type])
    @@map("infrastructure_systems")
}

// model Equipment {
//     id                  Int                  @id @default(autoincrement())
//     patrimonyTag        String?              @unique
//     name                String
//     description         String?              @db.Text
//     location            String?
//     serialNumber        String?
//     manufacturer        String?
//     model               String?
//     acquisitionDate     DateTime?
//     isActive            Boolean              @default(true)
//     createdAt           DateTime             @default(now())
//     updatedAt           DateTime             @updatedAt
//     maintenanceRequests MaintenanceRequest[]

//     @@map("equipments")
// }

// =================================================================
// ==                 MODELS PARA O FLUXO DE MANUTENÇÃO           ==
// =================================================================

model InfrastructureOccurrence {
    id                  Int                                     @id @default(autoincrement())
    title               String
    description         String                                  @db.Text
    locationDescription String?
    reportedAt          DateTime                                @default(now())
    status              InfrastructureOccurrenceStatus          @default(REPORTED)
    duplicateOfId       Int?
    duplicateOf         InfrastructureOccurrence?               @relation("DuplicateOccurrences", fields: [duplicateOfId], references: [id], onDelete: NoAction)
    duplicates          InfrastructureOccurrence[]              @relation("DuplicateOccurrences")
    reinforcements      InfrastructureOccurrenceReinforcement[]
    spaceId             Int?
    space               InfrastructureSpace?                    @relation(fields: [spaceId], references: [id], onDelete: SetNull)
    buildingId          String?
    building            InfrastructureBuilding?                 @relation(fields: [buildingId], references: [id], onDelete: SetNull)
    reportedById        Int
    reportedBy          User                                    @relation("ReportedOccurrences", fields: [reportedById], references: [id])
    diagnosis           InfrastructureOccurrenceDiagnosis?
    createdAt           DateTime                                @default(now()) @db.Timestamp(0)
    updatedAt           DateTime                                @updatedAt @db.Timestamp(0)

    @@index([reportedById, spaceId, buildingId, status, duplicateOfId])
    @@map("infrastructure_occurrences")
}

model InfrastructureOccurrenceReinforcement {
    occurrenceId Int
    occurrence   InfrastructureOccurrence @relation(fields: [occurrenceId], references: [id], onDelete: Cascade)
    userId       Int
    user         User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
    reinforcedAt DateTime                 @default(now())
    comment      String?

    @@id([occurrenceId, userId])
    @@map("infrastructure_occurrence_reinforcements")
}

enum InfrastructureOccurrenceStatus {
    REPORTED  @map("REPORTADO")
    ANALYZING @map("ANALISANDO")
    ACCEPTED  @map("ACEITO")
    REJECTED  @map("NEGADO")
    DISMISSED @map("IMPROCEDENTE")
    RESOLVED  @map("RESOLVIDO")
    DUPLICATE @map("DUPLICADA")
}

model InfrastructureOccurrenceDiagnosis {
    id                   Int                      @id @default(autoincrement())
    diagnosticDetails    String                   @db.Text
    prognosis            String?                  @db.Text
    resolutionNotes      String?                  @db.Text
    outcome              DiagnosisOutcome         @default(PENDING)
    occurrenceId         Int                      @unique
    occurrence           InfrastructureOccurrence @relation(fields: [occurrenceId], references: [id], onDelete: Cascade)
    analyzedById         Int
    analyzedBy           User                     @relation("AnalyzedByUser", fields: [analyzedById], references: [id])
    diagnosedAt          DateTime                 @default(now())
    maintenanceRequestId Int?                     @unique
    maintenanceRequest   MaintenanceRequest?
    createdAt            DateTime                 @default(now()) @db.Timestamp(0)
    updatedAt            DateTime                 @updatedAt @db.Timestamp(0)

    estimatedResolutionTime Int? // Quantidade de tempo estimada. Ex: 4
    estimatedResolutionUnit TimeUnit? // Unidade de tempo. Ex: HOURS -> "4 Horas"

    requiresInterdiction Boolean @default(false) // Necessita de interdição da área?
    interdictionDetails  String? @db.Text // Detalhes da interdição (qual área, por quê, recomendações).

    wasteGenerated            Boolean @default(false) // A resolução gerará resíduos?
    wasteDisposalInstructions String? @db.Text // Instruções para o descarte correto dos resíduos.

    // Relação N-N com os tipos de risco associados
    associatedRisks InfrastructureOccurrenceDiagnosisRiskType[]

    @@index([analyzedById])
    @@map("infrastructure_occurrence_diagnosis")
}

enum DiagnosisOutcome {
    PENDING          @map("PENDENTE")
    CREATED_REQUEST  @map("REQUISICAO CRIADA")
    RESOLVED_ON_SITE @map("REPARO RAPIDO")
    DISMISS          @map("FALSO ALARME")
    REJECT           @map("NEGADO")
}

// Modelo para tipos de risco configuráveis.
model InfrastructureOccurrenceDiagnosisRiskType {
    id          Int     @id @default(autoincrement())
    name        String  @unique // Ex: "Risco à Saúde", "Risco ao Patrimônio", "Risco Ambiental"
    description String? // Descrição detalhada do risco.

    // Relação N-N com os diagnósticos que possuem este risco.
    diagnoses InfrastructureOccurrenceDiagnosis[]

    @@map("infrastructure_occurrence_diagnosis_risk_types")
}

// Enum para unidades de tempo.
enum TimeUnit {
    MINUTES @map("MINUTOS")
    HOURS   @map("HORAS")
    DAYS    @map("DIAS")
    WEEKS   @map("SEMANAS")
    MONTHS  @map("MESES")
}

model MaintenanceRequest {
    id                           Int                                @id @default(autoincrement())
    protocolNumber               String                             @unique @default(uuid())
    title                        String
    description                  String                             @db.Text
    priority                     RequestPriority                    @default(NORMAL)
    requestedAt                  DateTime                           @default(now())
    deadline                     DateTime?
    solutionDetails              String?                            @db.Text
    completedAt                  DateTime?
    spaceId                      Int?
    space                        InfrastructureSpace?               @relation(fields: [spaceId], references: [id], onDelete: SetNull)
    buildingId                   String?
    building                     InfrastructureBuilding?            @relation(fields: [buildingId], references: [id], onDelete: SetNull)
    systemId                     Int?
    system                       InfrastructureSystem?              @relation(fields: [systemId], references: [id], onDelete: SetNull)
    // equipmentId                  Int?
    // equipment                    Equipment?                      @relation(fields: [equipmentId], references: [id], onDelete: SetNull)
    currentMaintenanceInstanceId Int
    currentMaintenanceInstance   MaintenanceInstance                @relation("CurrentInstanceRequests", fields: [currentMaintenanceInstanceId], references: [id])
    createdById                  Int
    createdBy                    User                               @relation("CreatedByUser", fields: [createdById], references: [id])
    assignedToId                 Int?
    assignedTo                   User?                              @relation("AssignedToUser", fields: [assignedToId], references: [id])
    serviceTypeId                Int?
    serviceType                  MaintenanceServiceType?            @relation(fields: [serviceTypeId], references: [id], onDelete: SetNull)
    statusId                     Int
    status                       MaintenanceRequestStatus           @relation(fields: [statusId], references: [id])
    currentStatus                MaintenanceRequestStatusOptions    @default(PENDING)
    diagnosisId                  Int?                               @unique
    diagnosis                    InfrastructureOccurrenceDiagnosis? @relation(fields: [diagnosisId], references: [id], onDelete: SetNull)
    createdAt                    DateTime                           @default(now()) @db.Timestamp(0)
    updatedAt                    DateTime                           @updatedAt @db.Timestamp(0)
    timelineEvents               MaintenanceTimelineEvent[]
    materialRequests             MaterialRequest[]
    materialStockMovements       MaterialStockMovement[]
    materialWithdrawals          MaterialWithdrawal[]

    // Relação 1-para-N com as Ordens de Serviço geradas
    serviceOrders MaintenanceServiceOrder[]

    @@index([currentMaintenanceInstanceId, createdById, assignedToId, statusId, spaceId, buildingId, systemId, diagnosisId])
    @@map("maintenance_requests")
}

// NOVO: Ordem de Serviço, uma tarefa executável ligada a uma Requisição de Manutenção.
model MaintenanceServiceOrder {
    id             Int                @id @default(autoincrement())
    title          String
    description    String?            @db.Text
    status         ServiceOrderStatus @default(PENDING)
    scheduledStart DateTime?
    scheduledEnd   DateTime?
    actualStart    DateTime?
    actualEnd      DateTime?

    // --- MUDANÇA AQUI ---
    // A responsabilidade primária é da EQUIPE.
    assignedTeamId Int
    assignedTeam   WorkerTeam @relation(fields: [assignedTeamId], references: [id])

    // As pessoas específicas são definidas na alocação.
    allocations MaintenanceServiceOrderAllocation[]
    // --------------------

    maintenanceRequestId Int
    maintenanceRequest   MaintenanceRequest        @relation(fields: [maintenanceRequestId], references: [id], onDelete: Cascade)
    prerequisites        MaintenanceServiceOrder[] @relation("ServiceOrderDependencies")
    subsequentOrders     MaintenanceServiceOrder[] @relation("ServiceOrderDependencies")

    createdAt DateTime @default(now()) @db.Timestamp(0)
    updatedAt DateTime @updatedAt @db.Timestamp(0)

    @@index([maintenanceRequestId, assignedTeamId])
    @@map("maintenance_service_orders")
}

// =================================================================
// ==              MODELS DE SUPORTE E CONTEXTO                   ==
// =================================================================
model MaintenanceServiceType {
    id                  Int                  @id @default(autoincrement())
    name                String               @unique
    description         String?
    isActive            Boolean              @default(true)
    createdAt           DateTime             @default(now())
    updatedAt           DateTime             @updatedAt
    maintenanceRequests MaintenanceRequest[]

    @@map("maintenance_service_types")
}

model MaintenanceInstance {
    id                            Int                        @id @default(autoincrement())
    sipacId                       String?                    @unique
    name                          String                     @unique
    isActive                      Boolean                    @default(true)
    createdAt                     DateTime                   @default(now()) @db.Timestamp(0)
    updatedAt                     DateTime                   @updatedAt @db.Timestamp(0)
    currentMaintenanceRequests    MaintenanceRequest[]       @relation("CurrentInstanceRequests")
    timelineEventsTransferredFrom MaintenanceTimelineEvent[] @relation("TransferredFromInstanceEvents")
    timelineEventsTransferredTo   MaintenanceTimelineEvent[] @relation("TransferredToInstanceEvents")
    warehouses                    Warehouse[]
    InfrastructureBuilding        InfrastructureBuilding[]

    @@map("maintenance_instances")
}

model MaintenanceTimelineEvent {
    id                        Int                 @id @default(autoincrement())
    type                      TimelineEventType   @default(COMMENT)
    description               String              @db.Text
    eventData                 Json?
    occurredAt                DateTime            @default(now())
    maintenanceRequestId      Int
    maintenanceRequest        MaintenanceRequest  @relation(fields: [maintenanceRequestId], references: [id])
    actionById                Int
    actionBy                  User                @relation("ActionByUser", fields: [actionById], references: [id])
    transferredFromInstanceId Int
    transferredToInstanceId   Int
    transferredFromInstance   MaintenanceInstance @relation("TransferredFromInstanceEvents", fields: [transferredFromInstanceId], references: [id])
    transferredToInstance     MaintenanceInstance @relation("TransferredToInstanceEvents", fields: [transferredToInstanceId], references: [id])
    createdAt                 DateTime            @default(now()) @db.Timestamp(0)
    updatedAt                 DateTime            @updatedAt @db.Timestamp(0)

    @@index([maintenanceRequestId, actionById])
    @@map("maintenance_timeline_events")
}

model MaintenanceRequestStatus {
    id                  Int                  @id @default(autoincrement())
    name                String               @unique
    description         String?
    isFinal             Boolean              @default(false)
    order               Int                  @default(0)
    createdAt           DateTime             @default(now()) @db.Timestamp(0)
    updatedAt           DateTime             @updatedAt @db.Timestamp(0)
    maintenanceRequests MaintenanceRequest[]

    @@map("maintenance_request_statuses")
}

// NOVO: Modelo que aloca um profissional específico para uma Ordem de Serviço.
model MaintenanceServiceOrderAllocation {
    // Relações
    serviceOrderId Int
    serviceOrder   MaintenanceServiceOrder @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)

    workerId Int
    worker   Worker @relation(fields: [workerId], references: [id], onDelete: Cascade)

    // Papel na OS
    isLeader Boolean @default(false) // Indica se este profissional é o líder desta OS específica.

    // Metadados
    allocatedAt   DateTime @default(now())
    allocatedById Int? // Opcional: quem fez a alocação
    allocatedBy   User?    @relation("AllocatedByUser", fields: [allocatedById], references: [id], onDelete: SetNull)

    // Garante que um profissional só pode ser alocado uma vez para a mesma OS.
    @@id([serviceOrderId, workerId])
    @@map("maintenance_service_order_allocations")
}

// NOVO: Enum para o ciclo de vida de uma Ordem de Serviço.
enum ServiceOrderStatus {
    PENDING // Aguardando agendamento/recursos
    SCHEDULED // Agendada com data e equipe
    IN_PROGRESS // Em execução
    ON_HOLD // Pausada (ex: aguardando material chegar)
    COMPLETED // Concluída com sucesso
    CANCELLED // Cancelada
}

// =================================================================
// ==                         ENUMS                               ==
// =================================================================

enum RequestPriority {
    LOW
    NORMAL
    HIGH
    URGENT
}

enum MaintenanceRequestStatusOptions {
    PENDING
    APPROVED
    IN_PROGRESS
    ON_HOLD
    COMPLETED
    REJECTED
    CANCELLED
}

enum TimelineEventType {
    CREATION
    COMMENT
    STATUS_CHANGE
    PRIORITY_CHANGE
    ASSIGNMENT
    UNASSIGNMENT
    TRANSFER_INITIATED
    SOLUTION_REGISTERED
    MATERIAL_REQUESTED
    MATERIAL_STATUS_CHANGED
    DEADLINE_CHANGED
    CLOSED
    REOPENED
    ASSET_CHANGED
    // NOVO EVENTO POSSÍVEL:
    DIAGNOSIS_REGISTERED
}
